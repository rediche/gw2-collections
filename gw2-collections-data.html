<link rel="import" href="../polymer/polymer-element.html">
<!--<link rel="import" href="../gw2api-items/gw2api-items.html">-->
<!--<link rel="import" href="../polymer/lib/elements/dom-if.html">-->
<!--<link rel="import" href="../polymer/lib/elements/dom-repeat.html">-->

<link rel="import" href="./gw2api-achievements-groups.html">
<link rel="import" href="./gw2api-achievements-categories.html">

<!--
`gw2-collections-data`
Generate a the data for gw2-collections.html

@demo demo/index.html
-->

<dom-module id="gw2-collections-data">
  <template>
    <gw2api-achievements-groups auto 
      ids="45410F60-AB66-4146-A0F7-CE99250C4CB0"
      response="{{ achievementGroupsResponse }}"></gw2api-achievements-groups>

    <gw2api-achievements-categories auto
      id="achievementCategories"
      ids="[[ whitelistCategories ]]"
      response="{{ achievementCategoriesResponse }}"></gw2api-achievements-categories>
  </template>

  <script>
    /** @polymerElement */
    class Gw2CollectionsData extends Polymer.Element {
      static get is() { return 'gw2-collections-data'; }

      static get properties() {
        return {
          data: {
            type: Object,
            notify: true,
            computed: '_computeData(description, categories)',
            observer: '_dataChanged'
          },

          description: {
            type: String
          },

          categories: {
            type: Object
          },

          /**
           * Whitelisted achievement categories
           */
          whitelistCategories: {
            type: Array,
            value: [77, 75, 76]
          },

          /**
           * Whitelisted achivement collections
           */
          whitelistCollections: {
            type: Array,
            value: [1717, 1745]
          },

          lastRespondedData: {
            type: Object
          },

          achievementGroupsResponse: {
            type: Object,
            observer: '_handleAchievementGroupResponse'
          },

          achievementCategoriesResponse: {
            type: Object,
            observer: '_handleAchievementCategoryResponse'
          }
        };
      }

      /*static get observers() {
        return [
          '_dataChanged(data.*)'
        ]
      }*/

      _computeData(newDescription, newCategories) {
        var newData = {
          description: newDescription,
          categories: newCategories
        }

        return newData;
      }

      _handleAchievementGroupResponse(response) {
        return this.description = response.description;
      }

      _handleAchievementCategoryResponse(response) {
        var collectionWhitelist = this.whitelistCollections;
        //console.log("Response Cat:", response);
        
        // For each category in the response
        response.forEach(function(category) {

          // Make a new achivement list
          var newAchievementList = [];

          // For each item in the collection whitelist
          collectionWhitelist.forEach(function(id) {
            // Check if current whitelist ID is in the achievement list
            var achievementIndex = category.achievements.indexOf(id);

            // If it's in the achievement list
            if (achievementIndex > -1) {
              // Add that ID to the new achivement list
              newAchievementList.push(id);
            }
          });

          // Overwrite old achivement list
          category.achievements = newAchievementList;
        });

        //console.log("After:", response);
        this.categories = response;
      }

      _dataChanged(data) {
        //console.log("Data changed!", data);
      }
    }

    window.customElements.define(Gw2CollectionsData.is, Gw2CollectionsData);
  </script>
</dom-module>
